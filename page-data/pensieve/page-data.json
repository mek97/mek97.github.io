{
    "componentChunkName": "component---src-pages-pensieve-index-js",
    "path": "/pensieve/",
    "result": {"data":{"allMarkdownRemark":{"edges":[{"node":{"frontmatter":{"title":"Private 'pypiserver' with AWS S3 as backend storage","description":"Hack to host private pypi python package repository with S3 as storage backend","slug":"/pensieve/pypiserver-s3","date":"2020-11-23","tags":["Python","Pypi","Docker"],"draft":false},"html":"<h2>Problem</h2>\n<p>Currently <a href=\"https://github.com/pypiserver/pypiserver\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">pypiserver</a> does not support S3 as storage ( <a href=\"https://github.com/pypiserver/pypiserver/issues/253\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">issue link</a> )</p>\n<h2>Solution</h2>\n<p>Create a file as <code class=\"language-text\">s3_packages_sync.sh</code> which syncs <code class=\"language-text\">/root/pypi/packages/</code> path in container to s3 path. For example -</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#! /bin/sh</span>\naws s3 <span class=\"token function\">sync</span> /root/pypi/packages/ s3://<span class=\"token variable\">$S3_PATH</span> <span class=\"token parameter variable\">--region</span> ap-south-1 <span class=\"token parameter variable\">--exclude</span> <span class=\"token string\">'*'</span> <span class=\"token parameter variable\">--include</span> <span class=\"token string\">'*.whl'</span> <span class=\"token parameter variable\">--include</span> <span class=\"token string\">'*.tar.gz'</span> <span class=\"token operator\">|</span> <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"s/^/<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">date</span> <span class=\"token parameter variable\">-R</span><span class=\"token variable\">)</span></span> /\"</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token operator\">>></span> /root/pypi/logs/s3_sync.log</code></pre></div>\n<p>Create a Dockerfile as follows</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> python:3.8-alpine3.12</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apk update &amp;&amp; apk add bash</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> pip install awscli passlib==1.7.2 pypiserver==1.3.2</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> mkdir -p /root/pypi</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./htpasswd.txt ./pypi_homepage.html /root/pypi/</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> mkdir -p /root/pypi/packages/</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> s3_packages_sync.sh /etc/periodic/hourly/s3_sync_packages</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> chmod u+x /etc/periodic/hourly/s3_sync_packages</span></code></pre></div>\n<p>Now run pypiserver with docker run command as follows</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">bash</span> <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"crond &amp;&amp; pypi-server -p 8898 -P /root/pypi/htpasswd.txt -a list,update,download --disable-fallback --welcome /root/pypi/pypi_homepage.html /root/pypi/packages\"</span></code></pre></div>\n<p>Note:</p>\n<ul>\n<li>Inject the AWS credentials if required</li>\n<li>Since cron runs hourly, so publishing to S3 will at most take an hour.</li>\n</ul>"}}]}},"pageContext":{}},
    "staticQueryHashes": ["1994492073","3391063840","3618961439","4112399270","604461682"]}